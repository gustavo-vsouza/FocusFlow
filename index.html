<!DOCTYPE html>
<!-- (MODIFICADO) 'dark' agora é permanente -->
<html lang="pt-BR" class="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FocoFlow - Seu Hub de Produtividade</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        /* Estilos base para a aplicação */
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;

            /* (MODIFICADO) Fundo com gradiente sutil (Modo Escuro) */
            background-color: #0d131f;
            /* gray-950 */
            background-image: radial-gradient(circle at 1% 1%, #0c4a6e, #0d131f 90%);
        }

        /* Gradiente da marca */
        .brand-gradient {
            background-image: linear-gradient(to right, #2563EB, #3B82F6);
            transition: all 0.3s ease-in-out;
        }

        .brand-gradient:hover {
            box-shadow: 0 4px 15px -3px rgba(59, 130, 246, 0.4);
            filter: brightness(1.1);
        }

        .brand-gradient-text {
            background-image: linear-gradient(to right, #3B82F6, #60A5FA);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        /* (MODIFICADO) Estilo "Glassmorphism" para painéis */
        .panel {
            background-color: rgba(31, 41, 55, 0.8);
            /* gray-800/80 */
            border: 1px solid rgba(55, 65, 81, 0.7);
            /* gray-700/70 */
        }

        /* (MODIFICADO) Card de Tarefa */
        .task-card {
            transition: all 0.2s ease-in-out;
            border: 1px solid rgba(55, 65, 81, 0.7);
            /* gray-700/70 */
            background-color: rgba(31, 41, 55, 0.9);
            /* gray-800/90 */
        }

        .task-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.07), 0 4px 6px -2px rgba(0, 0, 0, 0.04);
        }

        /* (MODIFICADO) Estilos para Drag and Drop */
        .drag-handle {
            cursor: move;
        }

        .sortable-ghost {
            opacity: 0.4;
            background-color: #1e3a8a;
            /* Estilo escuro */
        }

        .sortable-chosen {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            transform: scale(1.02);
            background-color: #1f2937;
            /* Estilo escuro (gray-800) */
        }

        /* Oculta ícone de calendário padrão */
        .due-date-input::-webkit-calendar-picker-picker-indicator {
            display: none;
            -webkit-appearance: none;
        }

        /* Animações do Toast */
        @keyframes toast-in {
            from {
                transform: translateY(100%);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        @keyframes toast-out {
            from {
                transform: translateY(0);
                opacity: 1;
            }

            to {
                transform: translateY(100%);
                opacity: 0;
            }
        }

        .toast-in {
            animation: toast-in 0.3s ease-out forwards;
        }

        .toast-out {
            animation: toast-out 0.3s ease-in forwards;
        }

        /* (MODIFICADO) Estilização do Checkbox */
        .custom-checkbox-container {
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        .custom-checkbox-visual {
            display: inline-block;
        }

        .custom-checkbox-input:checked+.custom-checkbox-visual {
            background-color: #3B82F6;
            border-color: #3B82F6;
        }

        .custom-checkbox-input:checked+.custom-checkbox-visual::after {
            content: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="none" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M4 10l4 4L16 6" /></svg>');
            display: block;
            width: 100%;
            height: 100%;
            transform: scale(0.9);
            animation: pop-in 0.15s ease-out;
        }

        @keyframes pop-in {
            from {
                transform: scale(0.5);
                opacity: 0;
            }

            to {
                transform: scale(0.9);
                opacity: 1;
            }
        }

        .custom-checkbox-input:focus-visible+.custom-checkbox-visual {
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.5);
            outline: 2px solid transparent;
        }

        /* Estilos do Modal */
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
            transition: opacity 0.2s ease-in-out;
        }

        /* (NOVO) Transição de entrada para modal (usado por ambos os modais) */
        .modal-content-enter {
            transition: all 0.2s ease-out;
            transform: scale(0.95);
            opacity: 0;
        }

        .modal-content-enter-active {
            transform: scale(1);
            opacity: 1;
        }

        /* (NOVO) Transição de saída para modal (usado por ambos os modais) */
        .modal-content-leave {
            transition: all 0.15s ease-in;
            transform: scale(1);
            opacity: 1;
        }

        .modal-content-leave-active {
            transform: scale(0.95);
            opacity: 0;
        }


        /* Ajuste no ícone de expandir/recolher */
        details[open] .details-arrow {
            transform: rotate(180deg);
        }

        /* Estilo para ícones de ação */
        .task-action-btn {
            transition: all 0.15s ease-in-out;
        }

        .task-action-btn:hover {
            transform: scale(1.1);
        }

        /* (NOVO) Classe genérica para ícones SVG */
        .svg-icon {
            width: 1.25rem;
            /* 20px (w-5) */
            height: 1.25rem;
            /* 20px (h-5) */
            stroke: currentColor;
            stroke-width: 2;
            fill: none;
            stroke-linecap: round;
            stroke-linejoin: round;
        }

        .svg-icon-sm {
            width: 1rem;
            /* 16px (w-4) */
            height: 1rem;
            /* 16px (h-4) */
            stroke: currentColor;
            stroke-width: 2;
            fill: none;
            stroke-linecap: round;
            stroke-linejoin: round;
        }

        .svg-icon-lg {
            width: 1.75rem;
            /* 28px (w-7) */
            height: 1.75rem;
            /* 28px (h-7) */
            stroke: currentColor;
            stroke-width: 2;
            fill: none;
            stroke-linecap: round;
            stroke-linejoin: round;
        }
    </style>
</head>

<!-- (MODIFICADO) Classes de body simplificadas para dark mode -->

<body class="text-gray-100 min-h-screen transition-colors duration-200">

    <!-- Container Principal -->
    <div class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">

        <!-- Cabeçalho -->
        <header class="flex flex-col sm:flex-row justify-between items-center mb-6 gap-4">
            <!-- Logo e Título -->
            <div class="flex items-center gap-3">
                <div class="p-2.5 brand-gradient rounded-lg shadow-lg">
                    <!-- (MODIFICADO) Ícone SVG inline -->
                    <span id="logo-icon-placeholder"></span>
                </div>
                <!-- (MODIFICADO) Cor do texto simplificada -->
                <h1 class="text-3xl font-bold text-white">
                    Foco<span class="brand-gradient-text">Flow</span>
                </h1>
                <!-- (MODIFICADO) Cor do texto simplificada -->
                <span class="text-sm text-gray-400 font-medium">v2.1</span> <!-- (MODIFICADO) Versão -->
            </div>

            <!-- Controles do Cabeçalho -->
            <div class="flex items-center gap-2 sm:gap-4">

                <!-- (MODIFICADO) Botão de Importar simplificado -->
                <label for="file-import"
                    class="relative cursor-pointer px-3 py-2 text-sm font-medium text-gray-300 bg-gray-800 rounded-md border border-gray-700 hover:bg-gray-700 shadow-sm transition-colors"
                    title="Importar .xlsx ou .csv"> <!-- (MODIFICADO) Título -->
                    <!-- (MODIFICADO) Ícone SVG inline -->
                    <span id="import-icon-placeholder"></span>
                    <!-- (MODIFICADO) Aceita .xlsx e .csv -->
                    <input type="file" id="file-import" accept=".xlsx, .csv" class="sr-only">
                </label>

                <!-- (MODIFICADO) Botão de Exportar simplificado -->
                <button id="export-button"
                    class="px-3 py-2 text-sm font-medium text-gray-300 bg-gray-800 rounded-md border border-gray-700 hover:bg-gray-700 shadow-sm transition-colors"
                    title="Exportar .xlsx">
                    <!-- (MODIFICADO) Ícone SVG inline -->
                    <span id="export-icon-placeholder"></span>
                </button>

                <!-- (MODIFICADO) Botão de Ocultar/Exibir simplificado -->
                <button id="toggle-form-button"
                    class="px-3 py-2 text-sm font-medium text-gray-300 bg-gray-800 rounded-md border border-gray-700 hover:bg-gray-700 shadow-sm transition-colors"
                    title="Ocultar formulário">
                    <!-- O ícone será definido pelo JS -->
                </button>
            </div>
        </header>

        <!-- Formulário de Adição de Tarefa -->
        <form id="add-task-form" class="panel mb-6 p-4 rounded-lg shadow-lg">
            <h2 class="text-xl font-semibold mb-4 text-white">Adicionar Nova Demanda</h2>

            <div class="flex flex-col sm:flex-row sm:items-center gap-3">
                <!-- (MODIFICADO) Input Principal simplificado -->
                <div class="flex-grow">
                    <label for="task-text" class="sr-only">Descrição da Demanda</label>
                    <input type="text" id="task-text" placeholder="Qual é a nova demanda?"
                        class="w-full px-4 py-3 rounded-md bg-gray-700 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 h-[50px]">
                </div>

                <!-- (MODIFICADO) Seletor de Prioridade simplificado -->
                <div class="flex-shrink-0">
                    <label for="task-priority" class="sr-only">Prioridade</label>
                    <select id="task-priority"
                        class="w-full sm:w-auto px-4 py-3 rounded-md bg-gray-700 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 h-[50px]">
                        <option value="alta">Prioridade: Alta</option>
                        <option value="media" selected>Prioridade: Média</option>
                        <option value="baixa">Prioridade: Baixa</option>
                    </select>
                </div>

                <!-- (NOVO) Seletor de Recorrência -->
                <div class="flex-shrink-0">
                    <label for="task-recurrence" class="sr-only">Recorrência</label>
                    <select id="task-recurrence"
                        class="w-full sm:w-auto px-4 py-3 rounded-md bg-gray-700 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 h-[50px]">
                        <option value="none" selected>Recorrência: Nenhuma</option>
                        <option value="daily">Recorrência: Diária</option>
                        <option value="weekly">Recorrência: Semanal</option>
                        <option value="monthly">Recorrência: Mensal</option>
                    </select>
                </div>

                <!-- (MODIFICADO) Seletor de Data simplificado -->
                <div class="flex-shrink-0">
                    <label for="task-due-date" class="sr-only">Data de Vencimento</label>
                    <input type="date" id="task-due-date" title="Data de Vencimento"
                        class="w-full sm:w-auto px-4 py-3 rounded-md bg-gray-700 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 h-[50px] text-gray-300">
                </div>
            </div>

            <!-- Botões de Adicionar -->
            <div class="flex flex-col sm:flex-row gap-3 mt-4">
                <!-- (MODIFICADO) Botão Primário simplificado -->
                <button type="submit" data-list="focus"
                    class="brand-gradient flex-1 flex justify-center items-center gap-2 px-5 py-3 rounded-md text-white font-semibold shadow-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 focus:ring-offset-gray-800 transition-all h-[50px]">
                    <!-- (MODIFICADO) Ícone SVG inline -->
                    <span id="focus-add-icon-placeholder"></span>
                    Adicionar ao Foco do Dia
                </button>
                <!-- (MODIFICADO) Botão Secundário simplificado -->
                <button type="submit" data-list="backlog"
                    class="flex-1 flex justify-center items-center gap-2 px-5 py-3 rounded-md bg-gray-700 border border-gray-600 text-white font-semibold shadow-sm hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-offset-2 focus:ring-offset-gray-800 transition-all h-[50px]">
                    <!-- (MODIFICADO) Ícone SVG inline -->
                    <span id="backlog-add-icon-placeholder"></span>
                    Salvar no Backlog
                </button>
            </div>
        </form>

        <!-- Colunas de Tarefas -->
        <main class="grid grid-cols-1 lg:grid-cols-2 gap-6">

            <!-- Coluna: Foco do Dia -->
            <section id="focus-section">
                <div class="flex justify-between items-center mb-4">
                    <!-- (MODIFICADO) Cor do texto simplificada -->
                    <h2 class="text-2xl font-bold flex items-center gap-2 text-white">
                        <!-- (MODIFICADO) Ícone SVG inline -->
                        <span id="focus-title-icon-placeholder"></span>
                        Foco do Dia
                    </h2>
                    <!-- (MODIFICADO) Cor do ícone simplificada -->
                    <button id="reset-focus-button" class="p-2 text-gray-400 hover:text-blue-400 transition-colors"
                        title="Resetar Tarefas Concluídas do Dia">
                        <!-- Icon: Reset (definido por JS) -->
                    </button>
                </div>
                <div id="focus-list" class="task-list space-y-3 min-h-[200px] p-2 panel rounded-lg">
                    <!-- Cards do Foco do Dia serão inseridos aqui -->
                </div>
            </section>

            <!-- Coluna: Backlog -->
            <section id="backlog-section">
                <!-- (MODIFICADO) Cor do texto simplificada -->
                <h2 class="text-2xl font-bold flex items-center gap-2 mb-4 text-white">
                    <!-- (MODIFICADO) Ícone SVG inline -->
                    <span id="backlog-title-icon-placeholder"></span>
                    Backlog
                </h2>
                <div id="backlog-list" class="task-list space-y-3 min-h-[200px] p-2 panel rounded-lg">
                    <!-- Cards do Backlog serão inseridos aqui -->
                </div>
            </section>

        </main>

        <!-- Seção: Tarefas Concluídas (do Backlog) -->
        <section id="completed-section" class="mt-8">
            <details class="panel rounded-lg shadow-sm overflow-hidden">
                <!-- (MODIFICADO) Cores simplificadas -->
                <summary
                    class="p-4 cursor-pointer flex justify-between items-center text-lg font-semibold text-green-400 hover:bg-gray-700/50 transition-colors">
                    <span class="flex items-center gap-2">
                        <!-- (MODIFICADO) Ícone SVG inline -->
                        <span id="completed-title-icon-placeholder"></span>
                        Tarefas Concluídas (Backlog)
                    </span>
                    <!-- (MODIFICADO) Ícone SVG inline -->
                    <span id="completed-arrow-icon-placeholder" class="transition-transform details-arrow"></span>
                </summary>
                <!-- (MODIFICADO) Cor da borda simplificada -->
                <div id="completed-list" class="p-4 border-t border-gray-700 space-y-3">
                    <!-- Cards Concluídos (do Backlog) serão inseridos aqui -->
                </div>
            </details>
        </section>

        <!-- (NOVO) Seção: Histórico de Excluídos -->
        <section id="deleted-section" class="mt-8">
            <details class="panel rounded-lg shadow-sm overflow-hidden">
                <summary
                    class="p-4 cursor-pointer flex justify-between items-center text-lg font-semibold text-gray-500 hover:bg-gray-700/50 transition-colors">
                    <span class="flex items-center gap-2">
                        <!-- Ícone SVG inline -->
                        <span id="deleted-title-icon-placeholder"></span>
                        Histórico de Excluídos
                    </span>
                    <!-- Ícone SVG inline -->
                    <span id="deleted-arrow-icon-placeholder" class="transition-transform details-arrow"></span>
                </summary>
                <div id="deleted-list" class="p-4 border-t border-gray-700 space-y-3">
                    <!-- Cards Excluídos serão inseridos aqui -->
                </div>
            </details>
        </section>


    </div> <!-- Fim do Container Principal -->

    <!-- (NOVO) Rodapé com Marca D'água -->
    <footer class="mt-8 py-4 border-t border-gray-700/50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center text-sm text-gray-500">
            <p>Criado por <span class="text-blue-400 font-medium">Gustavo Souza</span></p>
        </div>
    </footer>

    <!-- (Toast) Notificação Global -->
    <div id="toast-notification"
        class="fixed bottom-8 right-8 p-4 rounded-lg shadow-xl text-white max-w-sm z-50 transition-all duration-300 translate-y-full opacity-0"
        style="display: none;">
        <span id="toast-message"></span>
    </div>

    <!-- Modal de Notas -->
    <div id="notes-modal" class="fixed inset-0 z-40 flex items-center justify-center p-4 hidden">
        <!-- Backdrop -->
        <div id="notes-modal-backdrop" class="modal-backdrop fixed inset-0 transition-opacity opacity-0"
            style="display: none;"></div>

        <!-- (MODIFICADO) Conteúdo do Modal simplificado -->
        <div id="notes-modal-content"
            class="relative z-50 w-full max-w-lg bg-gray-800 rounded-lg shadow-2xl p-6 modal-content-enter"
            style="display: none;">
            <!-- Cabeçalho do Modal -->
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold text-white">Editar Demanda</h3> <!-- (MODIFICADO) Título do Modal -->
                <!-- (MODIFICADO) Botão de fechar simplificado -->
                <button id="notes-modal-close" class="p-1 rounded-full text-gray-400 hover:bg-gray-700 hover:text-white"
                    title="Fechar">
                    <!-- (MODIFICADO) Ícone SVG inline -->
                    <span id="modal-close-icon-placeholder"></span>
                </button>
            </div>

            <!-- Formulário do Modal -->
            <form id="notes-modal-form">
                <input type="hidden" id="notes-modal-task-id">

                <!-- (NOVO) Label para o Título da Demanda -->
                <label for="notes-modal-task-text" class="block text-sm font-medium text-gray-400 mb-2">
                    Demanda:
                </label>
                <!-- (MODIFICADO) Input para o Título da Demanda -->
                <input type="text" id="notes-modal-task-text"
                    class="w-full p-3 rounded-md bg-gray-900 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500"
                    placeholder="Descrição da Demanda">

                <!-- (NOVO) Label para Prioridade -->
                <label for="notes-modal-priority" class="block text-sm font-medium text-gray-400 mb-2 mt-4">
                    Prioridade:
                </label>
                <!-- (NOVO) Seletor de Prioridade no Modal -->
                <select id="notes-modal-priority"
                    class="w-full p-3 rounded-md bg-gray-900 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="alta">Alta</option>
                    <option value="media">Média</option>
                    <option value="baixa">Baixa</option>
                </select>

                <!-- (NOVO) Label para Recorrência -->
                <label for="notes-modal-recurrence" class="block text-sm font-medium text-gray-400 mb-2 mt-4">
                    Recorrência:
                </label>
                <!-- (NOVO) Seletor de Recorrência no Modal -->
                <select id="notes-modal-recurrence"
                    class="w-full p-3 rounded-md bg-gray-900 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="none">Nenhuma</option>
                    <option value="daily">Diária</option>
                    <option value="weekly">Semanal</option>
                    <option value="monthly">Mensal</option>
                </select>

                <!-- (MODIFICADO) Label simplificado -->
                <label for="notes-modal-textarea" class="block text-sm font-medium text-gray-400 mb-2 mt-4">
                    Detalhes e Notas:
                </label>
                <!-- (MODIFICADO) Textarea simplificado -->
                <textarea id="notes-modal-textarea" rows="8"
                    class="w-full p-3 rounded-md bg-gray-900 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500"
                    placeholder="Adicione detalhes, links, ou qualquer outra informação aqui..."></textarea>

                <!-- (MODIFICADO) Botão Salvar simplificado -->
                <div class="mt-6 flex justify-end">
                    <button type="submit"
                        class="brand-gradient px-5 py-2.5 rounded-md text-white font-semibold shadow-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 focus:ring-offset-gray-800 transition-all">
                        Salvar Demanda
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- (NOVO) Modal de Confirmação de Exclusão -->
    <div id="confirm-delete-modal" class="fixed inset-0 z-40 flex items-center justify-center p-4 hidden">
        <!-- Backdrop -->
        <div id="confirm-delete-backdrop" class="modal-backdrop fixed inset-0 transition-opacity opacity-0"
            style="display: none;"></div>

        <!-- Conteúdo do Modal -->
        <div id="confirm-delete-content"
            class="relative z-50 w-full max-w-md bg-gray-800 rounded-lg shadow-2xl p-6 modal-content-enter"
            style="display: none;">

            <div class="flex items-start">
                <!-- Ícone de Aviso -->
                <div
                    class="flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-red-900/50 sm:h-10 sm:w-10">
                    <span id="confirm-delete-icon-placeholder" class="text-red-400"></span>
                </div>
                <div class="ml-4 text-left">
                    <h3 class="text-lg font-semibold text-white" id="modal-title">
                        Excluir Demanda
                    </h3>
                    <div class="mt-2">
                        <p class="text-sm text-gray-300" id="confirm-delete-text">
                            Você tem certeza que deseja enviar esta demanda para o histórico de excluídos?
                        </p>
                    </div>
                </div>
            </div>

            <!-- Botões de Ação -->
            <div class="mt-6 flex flex-col-reverse sm:flex-row sm:justify-end gap-3">
                <button type="button" id="cancel-delete-btn"
                    class="w-full sm:w-auto px-4 py-2.5 rounded-md bg-gray-700 border border-gray-600 text-white font-semibold shadow-sm hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-offset-2 focus:ring-offset-gray-800 transition-all">
                    Cancelar
                </button>
                <button type="button" id="confirm-delete-btn"
                    class="w-full sm:w-auto px-4 py-2.5 rounded-md bg-red-600 text-white font-semibold shadow-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 focus:ring-offset-gray-800 transition-all">
                    Excluir
                </button>
            </div>
        </div>
    </div>


    <script>
        // --- Constantes da Aplicação ---
        const LOCAL_STORAGE_KEY = 'focoflow-tasks';
        const LOCAL_STORAGE_KEY_DELETED = 'focoflow-deleted-tasks'; // (NOVO)
        const FORM_VISIBLE_KEY = 'focoflow-form-visible';
        const TODAY_NORM = new Date();
        TODAY_NORM.setHours(0, 0, 0, 0);


        // --- Globais da Aplicação ---
        let localTasks = [];
        let localDeletedTasks = []; // (NOVO)
        let toastTimeout = null;
        let taskToModify = null; // (NOVO) Guarda o ID da tarefa para modais


        // --- Elementos da DOM ---
        const addTaskForm = document.getElementById('add-task-form');
        const taskTextInput = document.getElementById('task-text');
        const taskPriorityInput = document.getElementById('task-priority');
        const taskRecurrenceInput = document.getElementById('task-recurrence'); // (NOVO)
        const taskDueDateInput = document.getElementById('task-due-date');
        const focusList = document.getElementById('focus-list');
        const backlogList = document.getElementById('backlog-list');
        const completedList = document.getElementById('completed-list');
        const deletedList = document.getElementById('deleted-list'); // (NOVO)
        // (REMOVIDO) Elementos do Dark Mode
        const resetFocusButton = document.getElementById('reset-focus-button');
        const exportButton = document.getElementById('export-button');
        const importInput = document.getElementById('file-import');
        const toggleFormButton = document.getElementById('toggle-form-button');
        const toast = document.getElementById('toast-notification');
        const toastMessage = document.getElementById('toast-message');

        // Elementos do Modal de Notas
        const notesModal = document.getElementById('notes-modal');
        const notesModalBackdrop = document.getElementById('notes-modal-backdrop');
        const notesModalContent = document.getElementById('notes-modal-content');
        const notesModalCloseBtn = document.getElementById('notes-modal-close');
        const notesModalForm = document.getElementById('notes-modal-form');
        const notesModalTaskId = document.getElementById('notes-modal-task-id');
        const notesModalTaskText = document.getElementById('notes-modal-task-text'); // (MODIFICADO) Agora é um <input>
        const notesModalTextarea = document.getElementById('notes-modal-textarea');
        const notesModalPriority = document.getElementById('notes-modal-priority'); // (NOVO) Seletor de prioridade do modal
        const notesModalRecurrence = document.getElementById('notes-modal-recurrence'); // (NOVO) Seletor de recorrência do modal

        // (NOVO) Elementos do Modal de Confirmação
        const confirmDeleteModal = document.getElementById('confirm-delete-modal');
        const confirmDeleteBackdrop = document.getElementById('confirm-delete-backdrop');
        const confirmDeleteContent = document.getElementById('confirm-delete-content');
        const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
        const cancelDeleteBtn = document.getElementById('cancel-delete-btn');
        const confirmDeleteText = document.getElementById('confirm-delete-text');


        // --- (MODIFICADO) Dicionário de Ícones (agora usa SVG Inline) ---
        function getIcon(name) {
            const icons = {
                // Ícones de 20x20 (w-5, h-5)
                'delete': '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="svg-icon"><path d="M3 6h18m-2 0v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2m-6 5v6m4-6v6"/></svg>',
                'reopen': '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="svg-icon"><path d="M1 4v6h6m-3.5 10a9 9 0 1 0-2.12-6.38L1 14"/></svg>',
                'moveToFocus': '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="svg-icon"><circle cx="12" cy="12" r="4"/><path d="M12 2v2m0 16v2M4.93 4.93l1.41 1.41m11.32 11.32l1.41 1.41M2 12h2m16 0h2M4.93 19.07l1.41-1.41m11.32-11.32l1.41-1.41"/></svg>',
                'moveToBacklog': '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="svg-icon"><rect x="1" y="4" width="22" height="5" rx="2" ry="2"/><path d="M2 9v11a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9"/><path d="M10 14h4"/></svg>',
                'reset': '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="svg-icon"><path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5m13 1a9 9 0 0 0-9 9 9.75 9.75 0 0 0 6.74-2.74L21 16"/><path d="M21 21v-5h-5"/></svg>',
                'dragHandle': '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="svg-icon"><circle cx="12" cy="12" r="1"/><circle cx="12" cy="5" r="1"/><circle cx="12" cy="19" r="1"/></svg>',
                'notes': '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="svg-icon"><path d="M15.5 3H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V8.5L15.5 3Z"/><path d="M15 3v6h6"/></svg>',
                'notesFilled': '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="svg-icon" fill="currentColor"><path d="M15.5 3H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V8.5L15.5 3Z"/><path d="M15 3v6h6"/></svg>',
                'eye': '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="svg-icon"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></svg>',
                'eyeSlash': '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="svg-icon"><path d="M9.88 9.88a3 3 0 1 0 4.24 4.24"/><path d="M10.73 5.08A10.43 10.43 0 0 1 12 5c7 0 10 7 10 7a13.16 13.16 0 0 1-1.67 2.68"/><path d="M6.61 6.61A13.526 13.526 0 0 0 2 12s3 7 10 7a9.74 9.74 0 0 0 5.39-1.61"/><line x1="2" x2="22" y1="2" y2="22"/></svg>',
                'fileUp': '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="svg-icon"><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"/><path d="M14 2v4a2 2 0 0 0 2 2h4"/><path d="M12 12v6m-3-3 3-3 3 3"/></svg>',
                'fileDown': '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="svg-icon"><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"/><path d="M14 2v4a2 2 0 0 0 2 2h4"/><path d="M12 18v-6m-3 3 3 3 3-3"/></svg>',
                'chevronDown': '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="svg-icon"><path d="m6 9 6 6 6-6"/></svg>',
                'close': '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="svg-icon" style="width: 1.5rem; height: 1.5rem;"><path d="M18 6 6 18M6 6l12 12"/></svg>',
                'trash': '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="svg-icon"><path d="M3 6h18m-2 0v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>', // (NOVO)
                'alertTriangle': '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="svg-icon" style="width: 1.5rem; height: 1.5rem;"><path d="m21.73 18-8-14a2 2 0 0 0-3.46 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><line x1="12" x2="12" y1="9" y2="13"/><line x1="12" x2="12.01" y1="17" y2="17"/></svg>', // (NOVO)

                // Ícones de 16x16 (w-4, h-4)
                'calendar': '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="svg-icon-sm"><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></svg>',
                'alert': '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="svg-icon-sm"><path d="m21.73 18-8-14a2 2 0 0 0-3.46 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><line x1="12" x2="12" y1="9" y2="13"/><line x1="12" x2="12.01" y1="17" y2="17"/></svg>',
                'recurrence': '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="svg-icon-sm"><path d="M17 2.1l4 4-4 4"/><path d="M3 12.6v-1.2a4.8 4.8 0 0 1 4.8-4.8h13.4"/><path d="M7 21.9l-4-4 4-4"/><path d="M21 11.4v1.2a4.8 4.8 0 0 1-4.8 4.8H2.8"/></svg>', // (NOVO)

                // Ícones de 28x28 (w-7, h-7)
                'logo': '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="svg-icon-lg" stroke="white"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg>',
                'titleSun': '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="svg-icon-lg text-blue-500"><circle cx="12" cy="12" r="4"/><path d="M12 2v2m0 16v2M4.93 4.93l1.41 1.41m11.32 11.32l1.41 1.41M2 12h2m16 0h2M4.93 19.07l1.41-1.41m11.32-11.32l1.41-1.41"/></svg>',
                'titleArchive': '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="svg-icon-lg text-gray-500"><rect x="1" y="4" width="22" height="5" rx="2" ry="2"/><path d="M2 9v11a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9"/><path d="M10 14h4"/></svg>',

                // Ícones de 24x24 (w-6, h-6)
                'titleCompleted': '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="svg-icon" style="width: 1.5rem; height: 1.5rem;"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>',
                'titleDeleted': '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="svg-icon" style="width: 1.5rem; height: 1.5rem;"><path d="M3 6h18m-2 0v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>', // (NOVO)

            };
            return icons[name] || '';
        }

        // --- Funções de Texto e Status ---
        function getPriorityText(priority) {
            const map = { alta: 'Alta', media: 'Média', baixa: 'Baixa' };
            return map[priority] || 'Média';
        }

        function getStatusText(status) {
            return status === 'completed' ? 'Concluído' : 'Pendente';
        }

        // (NOVO)
        function getListText(list) {
            const map = { focus: 'Foco', backlog: 'Backlog' };
            return map[list] || 'Backlog';
        }

        // (NOVO)
        function getRecurrenceText(recurrence) {
            const type = (recurrence && recurrence.type) || 'none';
            const map = { daily: 'Diária', weekly: 'Semanal', monthly: 'Mensal', none: 'Nenhuma' };
            return map[type] || 'Nenhuma';
        }

        function getPriorityFromText(text) {
            const lowerText = text ? text.toLowerCase() : '';
            if (lowerText.includes('alta')) return 'alta';
            if (lowerText.includes('baixa')) return 'baixa';
            return 'media';
        }

        function getStatusFromText(text) {
            const lowerText = text ? text.toLowerCase() : '';
            // (MODIFICADO) Corrigido para retornar 'pending'
            return lowerText.includes('concluído') ? 'completed' : 'pending';
        }

        // (NOVO)
        function getListFromText(text) {
            const lowerText = text ? text.toLowerCase() : '';
            if (lowerText.includes('foco')) return 'focus';
            return 'backlog';
        }

        // (NOVO)
        function getRecurrenceFromText(text) {
            const lowerText = text ? text.toLowerCase() : '';
            if (lowerText.includes('diária')) return 'daily';
            if (lowerText.includes('semanal')) return 'weekly';
            if (lowerText.includes('mensal')) return 'monthly';
            return 'none';
        }

        function escapeAttr(str) {
            if (typeof str !== 'string') return '';
            return str.replace(/"/g, '&quot;');
        }

        // --- Funções de Ajuda de UI ---

        /** (MODIFICADO) Retorna classes e ícone para o indicador de data */
        function getDueDateIndicator(dueDateString) {
            if (!dueDateString) {
                return {
                    classes: 'text-gray-500',
                    icon: getIcon('calendar')
                };
            }
            const dateParts = dueDateString.split('-').map(Number);
            const dueDateNorm = new Date(dateParts[0], dateParts[1] - 1, dateParts[2]);
            const timeDiff = dueDateNorm.getTime() - TODAY_NORM.getTime();
            const dayDiff = Math.ceil(timeDiff / (1000 * 60 * 60 * 24));

            if (dayDiff < 0) {
                return { classes: 'text-red-400', icon: getIcon('alert') };
            }
            if (dayDiff === 0) {
                return { classes: 'text-yellow-400', icon: getIcon('calendar') };
            }
            if (dayDiff === 1) {
                return { classes: 'text-blue-400', icon: getIcon('calendar') };
            }
            return { classes: 'text-gray-400', icon: getIcon('calendar') };
        }

        /** (MODIFICADO) Retorna as classes de cor do Tailwind para cada prioridade */
        function getPriorityClasses(priority) {
            switch (priority) {
                case 'alta':
                    return {
                        badge: 'bg-red-900/70 text-red-200',
                        dot: 'bg-red-500'
                    };
                case 'media':
                    return {
                        badge: 'bg-yellow-900/70 text-yellow-200',
                        dot: 'bg-yellow-500'
                    };
                case 'baixa':
                    return {
                        badge: 'bg-blue-900/70 text-blue-200',
                        dot: 'bg-blue-500'
                    };
                default:
                    return {
                        badge: 'bg-gray-700 text-gray-200',
                        dot: 'bg-gray-400'
                    };
            }
        }

        /** (Toast) Mostra uma notificação global */
        function showToast(message, type = 'success') {
            if (toastTimeout) clearTimeout(toastTimeout);
            toastMessage.textContent = message;
            toast.classList.remove('bg-green-600', 'bg-red-600', 'bg-blue-600');
            if (type === 'error') {
                toast.classList.add('bg-red-600');
            } else if (type === 'info') {
                toast.classList.add('bg-blue-600');
            } else {
                toast.classList.add('bg-green-600');
            }
            toast.style.display = 'block';
            toast.classList.remove('toast-out', 'translate-y-full', 'opacity-0');
            toast.classList.add('toast-in');
            toastTimeout = setTimeout(() => {
                toast.classList.remove('toast-in');
                toast.classList.add('toast-out');
                setTimeout(() => { toast.style.display = 'none'; }, 300);
            }, 3000);
        }

        // --- Renderização ---

        /** Renderiza todas as listas de tarefas (ativas e concluídas) */
        function renderTasks() {
            focusList.innerHTML = '';
            backlogList.innerHTML = '';
            completedList.innerHTML = '';

            const focusTasks = localTasks.filter(t => t.list === 'focus' && t.status === 'pending');
            const focusCompletedTasks = localTasks.filter(t => t.list === 'focus' && t.status === 'completed');
            const backlogTasks = localTasks.filter(t => t.list === 'backlog' && t.status === 'pending');
            const backlogCompletedTasks = localTasks.filter(t => t.list === 'backlog' && t.status === 'completed');

            const sortedFocusTasks = [
                ...focusTasks.sort((a, b) => (a.order || 0) - (b.order || 0)),
                ...focusCompletedTasks.sort((a, b) => (a.createdAt || 0) - (b.createdAt || 0))
            ];

            if (sortedFocusTasks.length === 0) {
                focusList.innerHTML = '<p class="text-sm text-center text-gray-400 py-4">Seu dia está limpo. Adicione tarefas aqui!</p>';
            } else {
                sortedFocusTasks.forEach(task => focusList.appendChild(createTaskCard(task)));
            }

            if (backlogTasks.length === 0) {
                backlogList.innerHTML = '<p class="text-sm text-center text-gray-400 py-4">Backlog vazio.</p>';
            } else {
                backlogTasks
                    .sort((a, b) => (a.order || 0) - (b.order || 0))
                    .forEach(task => backlogList.appendChild(createTaskCard(task)));
            }

            if (backlogCompletedTasks.length === 0) {
                completedList.innerHTML = '<p class="text-sm text-center text-gray-400 py-4">Nenhuma tarefa do backlog concluída.</p>';
            } else {
                backlogCompletedTasks
                    .sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0))
                    .forEach(task => completedList.appendChild(createTaskCard(task)));
            }

            resetFocusButton.innerHTML = getIcon('reset');
            resetFocusButton.disabled = focusCompletedTasks.length === 0;
            resetFocusButton.classList.toggle('opacity-50', focusCompletedTasks.length === 0);
        }

        /** (NOVO) Renderiza a lista de tarefas excluídas */
        function renderDeletedTasks() {
            deletedList.innerHTML = '';
            if (localDeletedTasks.length === 0) {
                deletedList.innerHTML = '<p class="text-sm text-center text-gray-500 py-4">O histórico de excluídos está vazio.</p>';
            } else {
                localDeletedTasks
                    .sort((a, b) => (b.deletedAt || 0) - (a.deletedAt || 0)) // Ordena pelos mais recentes
                    .forEach(task => deletedList.appendChild(createDeletedTaskCard(task)));
            }
        }


        /** (MODIFICADO) Cria o HTML para um único card de tarefa (ativa/concluída) */
        function createTaskCard(task) {
            const { id, text, priority, status, list, dueDate, notes, recurrence } = task; // (MODIFICADO) Adiciona recurrence

            const card = document.createElement('div');
            card.className = `task-card flex items-center gap-3 p-3.5 rounded-lg shadow ${status === 'completed' ? 'opacity-60' : ''}`;
            card.dataset.task = JSON.stringify(task); // Guarda o objeto task inteiro
            card.dataset.taskId = id;

            let actionsHtml = '';
            const notesIcon = (notes && notes.trim() !== "") ? getIcon('notesFilled') : getIcon('notes');
            const notesTitle = (notes && notes.trim() !== "") ? 'Ver/Editar Demanda' : 'Adicionar Notas'; // (MODIFICADO) Título unificado
            const notesIconClass = (notes && notes.trim() !== "") ? 'text-blue-400' : '';

            if (status === 'pending') {
                const moveAction = (list === 'focus') ? 'moveToBacklog' : 'moveToFocus';
                actionsHtml = `
                    <button class="task-action-btn" data-action="open-notes" title="${notesTitle}">
                        <span class="${notesIconClass}">${notesIcon}</span>
                    </button>
                    <button class="task-action-btn" data-action="${moveAction}" title="${list === 'focus' ? 'Mover para Backlog' : 'Mover para Foco'}">
                        ${getIcon(moveAction)}
                    </button>
                    <button class="task-action-btn text-red-500/70 hover:text-red-400" data-action="delete" title="Excluir Tarefa">
                        ${getIcon('trash')}
                    </button>
                `;
            } else if (list === 'backlog') { // Concluído no Backlog
                actionsHtml = `
                     <button class="task-action-btn" data-action="open-notes" title="${notesTitle}">
                        <span class="${notesIconClass}">${notesIcon}</span>
                    </button>
                    <button class="task-action-btn" data-action="reopen" title="Reabrir Tarefa">
                        ${getIcon('reopen')}
                    </button>
                    <button class="task-action-btn text-red-500/70 hover:text-red-400" data-action="delete" title="Excluir Tarefa">
                        ${getIcon('trash')}
                    </button>
                `;
            } else { // Concluído no Foco do Dia
                actionsHtml = `
                    <button class="task-action-btn" data-action="open-notes" title="${notesTitle}">
                        <span class="${notesIconClass}">${notesIcon}</span>
                    </button>
                `;
            }

            const dragHandleHtml = (status === 'pending') ?
                `<span class="drag-handle flex-shrink-0 p-1 text-gray-500 hover:text-gray-200" data-action="drag">
                    ${getIcon('dragHandle')}
                </span>` :
                `<span class="flex-shrink-0 w-7"></span>`; // (MODIFICADO) Adicionado data-action="drag"

            const priorityClasses = getPriorityClasses(priority);

            // (NOVO) Adiciona ícone de recorrência
            const recurrenceIconHtml = (recurrence && recurrence.type !== 'none') ?
                `<span class="flex-shrink-0 text-blue-400" title="Tarefa Recorrente: ${getRecurrenceText(recurrence)}">${getIcon('recurrence')}</span>` :
                '';

            card.innerHTML = `
                ${dragHandleHtml}
                <label class="custom-checkbox-container flex-shrink-0 relative flex items-center justify-center h-5 w-5 cursor-pointer" title="${status === 'completed' ? 'Marcar como pendente' : 'Concluir tarefa'}">
                    <input type="checkbox" data-action="toggle-status" class="custom-checkbox-input absolute opacity-0 w-0 h-0" ${status === 'completed' ? 'checked' : ''}>
                    <span class="custom-checkbox-visual w-5 h-5 bg-gray-700 border-2 border-gray-600 rounded-md transition-all duration-200"></span>
                </label>
                
                <div class="flex-grow min-w-0">
                    <!-- (MODIFICADO) Adicionado data-action="edit-task" e title. Removido input inline. -->
                    <span 
                        class="task-text-display block w-full truncate cursor-pointer text-gray-100 ${status === 'completed' && list === 'focus' ? 'line-through' : ''}" 
                        data-action="edit-task" 
                        title="Editar Demanda"
                    >${escapeAttr(text)}</span>
                </div>

                <!-- (NOVO) Ícone de recorrência adicionado -->
                ${recurrenceIconHtml}
                
                <div class="due-date-container flex-shrink-0 w-[120px] flex justify-end">
                    ${createDueDateInput(dueDate)}
                </div>

                <span class="flex-shrink-0 text-xs font-semibold px-2.5 py-1 rounded-full flex items-center gap-1.5 ${priorityClasses.badge}">
                    <span class="h-2 w-2 rounded-full ${priorityClasses.dot}"></span>
                    <span>${getPriorityText(priority)}</span>
                </span>

                <div class="task-actions flex-shrink-0 flex items-center gap-2 text-gray-400">
                    ${actionsHtml}
                </div>
            `;

            card.querySelectorAll('.task-action-btn').forEach(btn => {
                btn.classList.add('p-1', 'rounded-md', 'hover:text-gray-200');
            });

            return card;
        }

        /** (NOVO) Cria o HTML para um card de tarefa excluída */
        function createDeletedTaskCard(task) {
            const { id, text, priority } = task;

            const card = document.createElement('div');
            // (MODIFICADO) Guarda o ID, não o objeto task inteiro
            card.dataset.taskId = id;
            card.className = 'task-card flex items-center gap-3 p-3.5 rounded-lg shadow opacity-70';

            const priorityClasses = getPriorityClasses(priority);

            card.innerHTML = `
                <span class="flex-shrink-0 w-7"></span> <!-- Espaçador (no lugar do drag/checkbox) -->
                
                <div class="flex-grow min-w-0">
                    <span class="task-text-display block w-full truncate text-gray-400 line-through">
                        ${escapeAttr(text)}
                    </span>
                </div>

                <span class="flex-shrink-0 text-xs font-semibold px-2.5 py-1 rounded-full flex items-center gap-1.5 ${priorityClasses.badge}">
                    <span class="h-2 w-2 rounded-full ${priorityClasses.dot}"></span>
                    <span>${getPriorityText(priority)}</span>
                </span>

                <div class="task-actions flex-shrink-0 flex items-center gap-2 text-gray-400">
                    <button class="task-action-btn text-green-400/80 hover:text-green-400" data-action="restore" title="Restaurar Tarefa">
                        ${getIcon('reopen')}
                    </button>
                    <button class="task-action-btn text-red-500/70 hover:text-red-400" data-action="delete-permanently" title="Excluir Permanentemente">
                        ${getIcon('delete')}
                    </button>
                </div>
            `;

            card.querySelectorAll('.task-action-btn').forEach(btn => {
                btn.classList.add('p-1', 'rounded-md');
            });

            return card;
        }


        /** (MODIFICADO) Helper para criar o input de data ou o botão de adicionar data */
        function createDueDateInput(dueDateString) {
            if (dueDateString) {
                const { classes, icon } = getDueDateIndicator(dueDateString);
                return `
                    <div class="due-date-wrapper relative flex items-center gap-1 ${classes} pr-2 rounded-md hover:bg-gray-700" title="Alterar data de vencimento">
                        ${icon}
                        <input 
                            type="date" 
                            value="${dueDateString}" 
                            data-action="set-due-date" 
                            class="due-date-input bg-transparent text-sm font-medium p-0 border-none focus:ring-0 appearance-none w-28 cursor-pointer"
                            style="color: currentColor;"
                        >
                    </div>
                `;
            } else {
                return `
                    <button 
                        class="due-date-add-btn p-2 rounded-md text-gray-500 hover:bg-gray-700 hover:text-blue-400 transition-colors"
                        data-action="add-due-date"
                        title="Adicionar data de vencimento"
                    >
                        ${getIcon('calendar')}
                    </button>
                `;
            }
        }


        // --- Funções CRUD Locais ---

        function loadTasks() {
            try {
                const tasksJson = localStorage.getItem(LOCAL_STORAGE_KEY);
                localTasks = tasksJson ? JSON.parse(tasksJson) : [];
                console.log("Tarefas ativas carregadas:", localTasks.length);
            } catch (e) {
                console.error("Erro ao carregar tarefas ativas:", e);
                localTasks = [];
                showToast("Erro ao carregar suas tarefas.", "error");
            }
            renderTasks();
        }

        function saveTasks() {
            try {
                localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(localTasks));
                console.log("Tarefas ativas salvas.");
            } catch (e) {
                console.error("Erro ao salvar tarefas ativas:", e);
                showToast("Não foi possível salvar suas tarefas.", "error");
            }
        }

        // (NOVO)
        function loadDeletedTasks() {
            try {
                const tasksJson = localStorage.getItem(LOCAL_STORAGE_KEY_DELETED);
                localDeletedTasks = tasksJson ? JSON.parse(tasksJson) : [];
                console.log("Tarefas excluídas carregadas:", localDeletedTasks.length);
            } catch (e) {
                console.error("Erro ao carregar tarefas excluídas:", e);
                localDeletedTasks = [];
            }
            renderDeletedTasks();
        }

        // (NOVO)
        function saveDeletedTasks() {
            try {
                localStorage.setItem(LOCAL_STORAGE_KEY_DELETED, JSON.stringify(localDeletedTasks));
                console.log("Tarefas excluídas salvas.");
            } catch (e) {
                console.error("Erro ao salvar tarefas excluídas:", e);
            }
        }

        // (NOVO) Calcula a próxima data de vencimento para tarefas recorrentes
        function calculateNextDueDate(task) {
            const { dueDate, recurrence } = task;
            const type = (recurrence && recurrence.type) || 'none';

            if (type === 'none' || !dueDate) {
                return dueDate; // Retorna a data existente se não houver recorrência ou data base
            }

            // Começa da data de vencimento *atual*
            const dateParts = dueDate.split('-').map(Number);
            const nextDate = new Date(dateParts[0], dateParts[1] - 1, dateParts[2]);
            nextDate.setHours(12, 0, 0, 0); // Evita problemas de fuso horário

            // Garante que a próxima data seja no futuro (depois de HOJE)
            const today = TODAY_NORM;

            switch (type) {
                case 'daily':
                    do {
                        nextDate.setDate(nextDate.getDate() + 1);
                    } while (nextDate <= today);
                    break;
                case 'weekly':
                    do {
                        nextDate.setDate(nextDate.getDate() + 7);
                    } while (nextDate <= today);
                    break;
                case 'monthly':
                    do {
                        nextDate.setMonth(nextDate.getMonth() + 1);
                    } while (nextDate <= today);
                    break;
                default:
                    return dueDate; // Tipo desconhecido, não faz nada
            }

            // Formata de volta para YYYY-MM-DD
            return nextDate.toISOString().split('T')[0];
        }

        // (NOVO) Verifica tarefas recorrentes no backlog que deveriam estar no Foco
        function checkRecurringTasks() {
            console.log("Verificando tarefas recorrentes...");
            const todayStr = TODAY_NORM.toISOString().split('T')[0];
            let tasksUpdated = false;

            localTasks.forEach((task, index) => {
                const recurrenceType = (task.recurrence && task.recurrence.type) || 'none';

                // Se for recorrente, estiver no backlog, pendente, e tiver uma data de vencimento
                if (recurrenceType !== 'none' && task.list === 'backlog' && task.status === 'pending' && task.dueDate) {

                    // Se a data de vencimento for hoje ou anterior
                    if (task.dueDate <= todayStr) {
                        console.log(`Movendo tarefa recorrente para o Foco: ${task.text}`);
                        localTasks[index].list = 'focus';
                        localTasks[index].order = Date.now() + index;
                        tasksUpdated = true;
                    }
                }
            });

            if (tasksUpdated) {
                saveTasks();
                renderTasks(); // Re-renderiza se houver mudanças
            }
        }


        function handleAddTask(e) {
            e.preventDefault();
            const listType = e.submitter.dataset.list;
            const text = taskTextInput.value.trim();
            const priority = taskPriorityInput.value;
            const recurrenceType = taskRecurrenceInput.value; // (NOVO)
            const dueDate = taskDueDateInput.value || null;

            if (!text) {
                taskTextInput.focus();
                showToast("Por favor, insira a descrição da demanda.", "info");
                return;
            }

            const now = Date.now();
            const newTaskWithId = {
                id: crypto.randomUUID(),
                text: text,
                priority: priority,
                status: 'pending',
                list: listType,
                dueDate: dueDate,
                notes: "",
                recurrence: { type: recurrenceType }, // (MODIFICADO)
                createdAt: now,
                order: now
            };

            localTasks.push(newTaskWithId);
            saveTasks();
            renderTasks();

            taskTextInput.value = '';
            taskPriorityInput.value = 'media';
            taskRecurrenceInput.value = 'none'; // (NOVO)
            taskDueDateInput.value = '';
        }

        function updateTask(id, updates) {
            let taskIndex = localTasks.findIndex(t => t.id === id);
            if (taskIndex > -1) {
                localTasks[taskIndex] = { ...localTasks[taskIndex], ...updates };
                saveTasks();
                renderTasks();
                console.log("Tarefa atualizada:", id, updates);
            }
        }

        /** (NOVO) Move uma tarefa da lista ativa para o histórico de excluídos */
        function archiveTask(id) {
            const taskIndex = localTasks.findIndex(t => t.id === id);
            if (taskIndex === -1) return;

            const [taskToArchive] = localTasks.splice(taskIndex, 1);
            taskToArchive.deletedAt = Date.now(); // Adiciona timestamp
            localDeletedTasks.push(taskToArchive);

            saveTasks();
            saveDeletedTasks();
            renderTasks();
            renderDeletedTasks();
            console.log("Tarefa arquivada:", id);
            showToast("Demanda movida para o histórico.", "info");
        }

        /** (NOVO) Restaura uma tarefa do histórico para o Backlog */
        function restoreTask(id) {
            const taskIndex = localDeletedTasks.findIndex(t => t.id === id);
            if (taskIndex === -1) return;

            const [taskToRestore] = localDeletedTasks.splice(taskIndex, 1);
            delete taskToRestore.deletedAt;
            taskToRestore.list = 'backlog'; // Padrão ao restaurar
            taskToRestore.status = 'pending';
            taskToRestore.order = Date.now();
            localTasks.push(taskToRestore);

            saveTasks();
            saveDeletedTasks();
            renderTasks();
            renderDeletedTasks();
            console.log("Tarefa restaurada:", id);
            showToast("Demanda restaurada para o Backlog.", "success");
        }

        /** (NOVO) Exclui permanentemente uma tarefa do histórico */
        function deletePermanently(id) {
            localDeletedTasks = localDeletedTasks.filter(t => t.id !== id);
            saveDeletedTasks();
            renderDeletedTasks();
            console.log("Tarefa excluída permanentemente:", id);
            showToast("Demanda excluída permanentemente.", "info");
        }


        function handleResetFocus() {
            let tasksUpdated = false;
            const now = Date.now();
            localTasks.forEach((task, index) => {
                if (task.list === 'focus' && task.status === 'completed') {
                    task.status = 'pending';
                    task.order = now + index;
                    tasksUpdated = true;
                }
            });

            if (tasksUpdated) {
                saveTasks();
                renderTasks();
                showToast("Tarefas do dia resetadas!", "success");
            } else {
                showToast("Nenhuma tarefa concluída para resetar.", "info");
            }
        }

        // --- Funções do Modal de Notas ---

        function openNotesModal(task) {
            notesModalTaskId.value = task.id;
            notesModalTaskText.value = task.text; // (MODIFICADO) Usa .value para input
            notesModalTextarea.value = task.notes || "";
            notesModalPriority.value = task.priority || "media"; // (NOVO) Define a prioridade atual
            notesModalRecurrence.value = (task.recurrence && task.recurrence.type) || "none"; // (NOVO) Define a recorrência

            notesModal.classList.remove('hidden');
            notesModalBackdrop.style.display = 'block';
            notesModalContent.style.display = 'block';

            void notesModalContent.offsetWidth; // Força o repaint para a animação

            notesModalBackdrop.classList.add('opacity-100');
            notesModalContent.classList.add('modal-content-enter-active');
            notesModalContent.classList.remove('modal-content-enter');


            // (MODIFICADO) Foca no input de texto se for uma edição de tarefa, senão foca no textarea
            const triggerAction = document.activeElement ? document.activeElement.dataset.action : null;
            if (triggerAction === 'edit-task') {
                notesModalTaskText.focus();
                notesModalTaskText.select();
            } else {
                notesModalTextarea.focus();
            }
        }

        function closeNotesModal() {
            notesModalBackdrop.classList.remove('opacity-100');
            notesModalContent.classList.remove('modal-content-enter-active');
            notesModalContent.classList.add('modal-content-leave-active');

            setTimeout(() => {
                notesModal.classList.add('hidden');
                notesModalBackdrop.style.display = 'none';
                notesModalContent.style.display = 'none';
                notesModalContent.classList.remove('modal-content-leave-active');
                notesModalContent.classList.add('modal-content-enter'); // Reseta para a próxima abertura
                // Limpa os campos
                notesModalTaskId.value = "";
                notesModalTaskText.value = ""; // (MODIFICADO) Usa .value para input
                notesModalTextarea.value = "";
                notesModalPriority.value = "media"; // (NOVO) Reseta a prioridade
                notesModalRecurrence.value = "none"; // (NOVO) Reseta a recorrência
            }, 150);
        }

        // (MODIFICADO) Salva tanto o texto da demanda quanto as notas
        function handleSaveNotes(e) {
            e.preventDefault();
            const taskId = notesModalTaskId.value;
            const newText = notesModalTaskText.value.trim();
            const newNotes = notesModalTextarea.value;
            const newPriority = notesModalPriority.value; // (NOVO) Pega a nova prioridade
            const newRecurrenceType = notesModalRecurrence.value; // (NOVO) Pega a nova recorrência

            if (!newText) {
                showToast("A demanda não pode ficar em branco.", "error");
                notesModalTaskText.focus();
                return;
            }

            if (taskId) {
                updateTask(taskId, {
                    text: newText,
                    notes: newNotes,
                    priority: newPriority,
                    recurrence: { type: newRecurrenceType } // (MODIFICADO) Salva a recorrência
                });
                showToast("Demanda salva com sucesso!", "success");
            }
            closeNotesModal();
        }

        // --- (NOVO) Funções do Modal de Confirmação ---

        function openDeleteConfirmModal(task) {
            taskToModify = task.id; // Armazena o ID da tarefa
            confirmDeleteText.textContent = `Você tem certeza que deseja enviar esta demanda para o histórico de excluídos?`;
            confirmDeleteBtn.textContent = "Excluir";
            confirmDeleteBtn.dataset.action = "archive"; // Define a ação

            confirmDeleteModal.classList.remove('hidden');
            confirmDeleteBackdrop.style.display = 'block';
            confirmDeleteContent.style.display = 'block';

            void confirmDeleteContent.offsetWidth; // Força repaint

            confirmDeleteBackdrop.classList.add('opacity-100');
            confirmDeleteContent.classList.add('modal-content-enter-active');
            confirmDeleteContent.classList.remove('modal-content-enter');

            confirmDeleteBtn.focus();
        }

        function openDeletePermanentlyConfirmModal(taskId) {
            taskToModify = taskId;
            confirmDeleteText.textContent = "Esta ação é irreversível. Deseja excluir permanentemente esta demanda?";
            confirmDeleteBtn.textContent = "Excluir Permanentemente";
            confirmDeleteBtn.dataset.action = "delete-permanently"; // Define a ação

            confirmDeleteModal.classList.remove('hidden');
            confirmDeleteBackdrop.style.display = 'block';
            confirmDeleteContent.style.display = 'block';

            void confirmDeleteContent.offsetWidth;

            confirmDeleteBackdrop.classList.add('opacity-100');
            confirmDeleteContent.classList.add('modal-content-enter-active');
            confirmDeleteContent.classList.remove('modal-content-enter');

            confirmDeleteBtn.focus();
        }


        function closeDeleteConfirmModal() {
            confirmDeleteBackdrop.classList.remove('opacity-100');
            confirmDeleteContent.classList.remove('modal-content-enter-active');
            confirmDeleteContent.classList.add('modal-content-leave-active');

            setTimeout(() => {
                confirmDeleteModal.classList.add('hidden');
                confirmDeleteBackdrop.style.display = 'none';
                confirmDeleteContent.style.display = 'none';
                confirmDeleteContent.classList.remove('modal-content-leave-active');
                confirmDeleteContent.classList.add('modal-content-enter'); // Reseta
                taskToModify = null;
            }, 150);
        }

        function handleConfirmDelete() {
            if (!taskToModify) return;

            const action = confirmDeleteBtn.dataset.action;
            if (action === "archive") {
                archiveTask(taskToModify);
            } else if (action === "delete-permanently") {
                deletePermanently(taskToModify);
            }

            closeDeleteConfirmModal();
        }



        // --- Manipuladores de Eventos (Clicks, Edição) ---

        // (MODIFICADO) handleListClick agora usa data-action para tudo
        function handleListClick(e) {
            const clickableElement = e.target.closest('[data-action]');

            if (clickableElement && clickableElement.dataset.action === 'drag') {
                return;
            }

            if (!clickableElement) return;

            const card = e.target.closest('.task-card');
            if (!card) return;

            // (MODIFICADO) Pega a task *do dataset*
            const task = JSON.parse(card.dataset.task);
            const action = clickableElement.dataset.action;

            switch (action) {
                // (MODIFICADO) Lógica de conclusão para recorrência
                case 'toggle-status':
                    const isChecking = clickableElement.checked;

                    if (isChecking) {
                        // Marcar como concluído
                        const recurrenceType = (task.recurrence && task.recurrence.type) || 'none';

                        // A tarefa só é recorrente SE tiver um tipo E uma data de vencimento
                        if (recurrenceType !== 'none' && task.dueDate) {
                            // É uma tarefa recorrente
                            const nextDueDate = calculateNextDueDate(task);
                            updateTask(task.id, {
                                list: 'backlog', // Mover de volta para o backlog
                                dueDate: nextDueDate,
                                status: 'pending', // Manter pendente
                                order: Date.now()
                            });
                            showToast("Tarefa recorrente reagendada!", "success");
                        } else {
                            // Tarefa normal, não recorrente (ou sem data)
                            updateTask(task.id, { status: 'completed' });
                        }
                    } else {
                        // Marcar como pendente (comportamento normal)
                        updateTask(task.id, { status: 'pending' });
                    }
                    break;
                case 'moveToFocus':
                    updateTask(task.id, { list: 'focus', order: Date.now() });
                    break;
                case 'moveToBacklog':
                    updateTask(task.id, { list: 'backlog', order: Date.now() });
                    break;
                case 'reopen':
                    updateTask(task.id, { status: 'pending', order: Date.now() });
                    break;
                case 'add-due-date':
                    const todayStr = new Date().toISOString().split('T')[0];
                    updateTask(task.id, { dueDate: todayStr });
                    break;
                case 'open-notes':
                    openNotesModal(task);
                    break;
                // (NOVO) Caso para editar a tarefa
                case 'edit-task':
                    if (task.status === 'completed' && task.list === 'focus') { // (MODIFICADO) Permite edição de concluídas do backlog
                        showToast("Não é possível editar tarefas concluídas do 'Foco do Dia'.", "info");
                        return;
                    }
                    openNotesModal(task);
                    break;
                case 'delete':
                    // (MODIFICADO) Chama o modal de confirmação em vez de excluir direto
                    openDeleteConfirmModal(task);
                    break;
            }
        }

        /** (NOVO) Manipulador de cliques para a lista de excluídos */
        function handleDeletedListClick(e) {
            const clickableElement = e.target.closest('[data-action]');
            if (!clickableElement) return;

            const card = e.target.closest('.task-card');
            if (!card) return;

            const taskId = card.dataset.taskId;
            const action = clickableElement.dataset.action;

            switch (action) {
                case 'restore':
                    restoreTask(taskId);
                    break;
                case 'delete-permanently':
                    // (MODIFICADO) Chama o modal de confirmação
                    openDeletePermanentlyConfirmModal(taskId);
                    break;
            }
        }


        function handleListChange(e) {
            const input = e.target;
            if (input.dataset.action === 'set-due-date') {
                const card = input.closest('.task-card');
                if (!card) return;
                const task = JSON.parse(card.dataset.task);
                const newDate = input.value || null;
                if (task.dueDate !== newDate) {
                    updateTask(task.id, { dueDate: newDate });
                }
            }
        }

        // --- Funções de Importar/Exportar (Excel) ---

        function handleExport() {
            if (localTasks.length === 0) {
                showToast("Nenhuma tarefa para exportar.", "info");
                return;
            }
            try {
                // (MODIFICADO) Adiciona lista (Foco/Backlog)
                const dataToExport = localTasks.map(task => ({
                    status: getStatusText(task.status),
                    lista: getListText(task.list), // (NOVO)
                    demanda: task.text,
                    prioridade: getPriorityText(task.priority),
                    recorrência: getRecurrenceText(task.recurrence),
                    vencimento: task.dueDate || '',
                    notas: task.notes || ''
                }));
                const ws = XLSX.utils.json_to_sheet(dataToExport);
                ws['!cols'] = [
                    { wch: 15 }, { wch: 12 }, { wch: 60 }, { wch: 15 }, { wch: 15 }, { wch: 12 }, { wch: 40 } // (MODIFICADO)
                ];
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'TESTE');

                // (MODIFICADO) Adiciona a data atual ao nome do arquivo
                const dateString = new Date().toISOString().split('T')[0]; // Formato YYYY-MM-DD
                const fileName = `FocoFlow_Export_${dateString}.xlsx`;
                XLSX.writeFile(wb, fileName);

                showToast("Tarefas exportadas com sucesso!", "success");
            } catch (e) {
                console.error("Erro ao exportar:", e);
                showToast("Ocorreu um erro ao exportar o arquivo.", "error");
            }
        }

        // (MODIFICADO) Função atualizada para lidar com .xlsx e .csv
        function handleImport(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            const fileExtension = file.name.split('.').pop().toLowerCase();

            reader.onload = (event) => {
                try {
                    let workbook;
                    let sheetName; // (NOVO)

                    if (fileExtension === 'xlsx') {
                        const data = new Uint8Array(event.target.result);
                        workbook = XLSX.read(data, { type: 'array' });
                        sheetName = 'TESTE'; // Para .xlsx, esperamos a planilha 'TESTE'
                        if (!workbook.SheetNames.includes(sheetName)) {
                            throw new Error(`Planilha "TESTE" não encontrada no arquivo .xlsx.`);
                        }
                    } else if (fileExtension === 'csv') {
                        const data = event.target.result; // String de readAsText
                        workbook = XLSX.read(data, { type: 'string' });
                        sheetName = workbook.SheetNames[0]; // Para .csv, apenas pegamos a *primeira* planilha
                        if (!sheetName) {
                            throw new Error("Arquivo CSV inválido ou vazio.");
                        }
                    } else {
                        throw new Error("Formato de arquivo não suportado. Use .xlsx ou .csv");
                    }

                    // (MODIFICADO) A lógica agora usa a 'sheetName' variável
                    const ws = workbook.Sheets[sheetName];
                    const jsonData = XLSX.utils.sheet_to_json(ws, { raw: false });

                    if (jsonData.length === 0) {
                        showToast("Nenhuma tarefa encontrada na planilha.", "info");
                        return;
                    }

                    const newTasks = [];
                    const now = Date.now();
                    jsonData.forEach((row, index) => {
                        const demanda = row['demanda'] || row['Demanda'];
                        if (!demanda) return; // Pula linha se não houver demanda

                        const statusRaw = row['status'] || row['Status'];
                        const listaRaw = row['lista'] || row['Lista']; // (NOVO)
                        const prioridadeRaw = row['prioridade'] || row['Prioridade'];
                        const recorrenciaRaw = row['recorrência'] || row['Recorrência']; // (NOVO)
                        const vencimentoRaw = row['vencimento'] || row['Vencimento'];
                        const notasRaw = row['notas'] || row['Notas'];

                        let vencimento = null;
                        if (vencimentoRaw) {
                            // Tenta analisar o número de série do Excel (data)
                            if (typeof vencimentoRaw === 'number' && vencimentoRaw > 1) {
                                const excelDate = new Date(Math.round((vencimentoRaw - 25569) * 86400 * 1000));
                                vencimento = excelDate.toISOString().split('T')[0];
                            }
                            // Tenta analisar formatos de string comuns
                            else if (typeof vencimentoRaw === 'string') {
                                if (/^\d{4}-\d{2}-\d{2}$/.test(vencimentoRaw)) {
                                    vencimento = vencimentoRaw;
                                } else if (/^\d{1,2}\/\d{1,2}\/\d{2,4}$/.test(vencimentoRaw)) {
                                    try {
                                        // Converte DD/MM/YYYY para YYYY-MM-DD
                                        const parts = vencimentoRaw.split('/');
                                        const day = parts[0].padStart(2, '0');
                                        const month = parts[1].padStart(2, '0');
                                        const year = parts[2].length === 2 ? '20' + parts[2] : parts[2];
                                        vencimento = `${year}-${month}-${day}`;
                                    } catch (dateError) {
                                        console.warn("Formato de data inválido:", vencimentoRaw);
                                    }
                                }
                            }
                        }

                        const status = getStatusFromText(statusRaw);
                        const prioridade = getPriorityFromText(prioridadeRaw);
                        const recorrencia = getRecurrenceFromText(recorrenciaRaw); // (NOVO)
                        const notas = (notasRaw || "").trim();

                        // (NOVO) Determina a lista
                        let listaFinal = 'backlog';
                        if (status === 'completed') {
                            listaFinal = 'backlog'; // Concluídas sempre vão para o backlog
                        } else {
                            listaFinal = getListFromText(listaRaw); // Foco ou Backlog
                        }

                        newTasks.push({
                            id: crypto.randomUUID(),
                            text: demanda.trim(),
                            priority: prioridade,
                            status: status,
                            list: listaFinal, // (MODIFICADO)
                            dueDate: vencimento,
                            notes: notas,
                            recurrence: { type: recorrencia }, // (NOVO)
                            createdAt: now + index,
                            order: now + index
                        });

                    });
                    if (newTasks.length > 0) {
                        localTasks = [...localTasks, ...newTasks];
                        saveTasks();
                        renderTasks();
                        showToast(`${newTasks.length} tarefas importadas com sucesso!`, "success");
                    } else {
                        showToast("A coluna 'demanda' não foi encontrada na planilha.", "info");
                    }
                } catch (e) {
                    console.error("Erro ao importar:", e);
                    showToast(e.message || "Erro ao ler o arquivo Excel.", "error");
                } finally {
                    e.target.value = null;
                }
            };

            // (NOVO) Decide como ler o arquivo
            if (fileExtension === 'xlsx') {
                reader.readAsArrayBuffer(file); // Para binário
            } else if (fileExtension === 'csv') {
                reader.readAsText(file, 'UTF-8'); // Para texto
            } else {
                showToast("Formato de arquivo inválido. Use .xlsx ou .csv", "error");
                e.target.value = null; // Limpa o input
            }
        }

        // --- Funções de Visibilidade do Formulário ---
        function initFormVisibility() {
            const userPref = localStorage.getItem(FORM_VISIBLE_KEY);
            if (userPref === 'false') {
                addTaskForm.classList.add('hidden');
                toggleFormButton.innerHTML = getIcon('eye');
                toggleFormButton.title = 'Mostrar formulário';
            } else {
                addTaskForm.classList.remove('hidden');
                toggleFormButton.innerHTML = getIcon('eyeSlash');
                toggleFormButton.title = 'Ocultar formulário';
            }
            // (NOVO) Renderiza o ícone inicial do toggle
            renderStaticIcons();
        }

        function toggleAddTaskForm() {
            const isHidden = addTaskForm.classList.toggle('hidden');
            if (isHidden) {
                localStorage.setItem(FORM_VISIBLE_KEY, 'false');
                toggleFormButton.innerHTML = getIcon('eye');
                toggleFormButton.title = 'Mostrar formulário';
            } else {
                localStorage.setItem(FORM_VISIBLE_KEY, 'true');
                toggleFormButton.innerHTML = getIcon('eyeSlash');
                toggleFormButton.title = 'Ocultar formulário';
                taskTextInput.focus();
            }
            // (NOVO) Processa o ícone que acabou de ser trocado
            renderStaticIcons();
        }

        // --- Inicialização do Drag and Drop (Sortable.js) ---
        function initSortable() {
            const listsToSort = [focusList, backlogList];
            listsToSort.forEach(listElement => {
                new Sortable(listElement, {
                    animation: 150,
                    handle: '.drag-handle',
                    ghostClass: 'sortable-ghost',
                    chosenClass: 'sortable-chosen',
                    filter: '.task-card[data-task*="\\"status\\":\\"completed\\""]',
                    onEnd: (evt) => {
                        const listId = evt.target.id;
                        const listType = listId === 'focus-list' ? 'focus' : 'backlog';

                        const cardElements = Array.from(evt.target.children)
                            .filter(el => el.classList.contains('task-card'));
                        const orderedIds = cardElements.map(el => el.dataset.taskId);

                        const now = Date.now();
                        let tasksUpdated = false;

                        orderedIds.forEach((id, index) => {
                            const taskIndex = localTasks.findIndex(t => t.id === id);
                            if (taskIndex > -1 && (localTasks[taskIndex].list === listType || evt.from !== evt.to)) {
                                localTasks[taskIndex].order = now + index;
                                tasksUpdated = true;
                            }
                        });

                        if (evt.from !== evt.to) {
                            const taskId = evt.item.dataset.taskId;
                            const newLocalListType = evt.to.id === 'focus-list' ? 'focus' : 'backlog';
                            const taskIndex = localTasks.findIndex(t => t.id === taskId);
                            if (taskIndex > -1) {
                                localTasks[taskIndex].list = newLocalListType;
                                tasksUpdated = true;
                            }
                        }

                        if (tasksUpdated) {
                            saveTasks();
                            if (evt.from !== evt.to) {
                                renderTasks();
                            }
                        }
                    },
                    group: 'shared-tasks'
                });
            });
        }


        // --- Inicialização da Aplicação ---
        function initApp() {
            console.log("Iniciando FocoFlow v2.1 (Import/Export de Lista)...");

            // Listeners Globais
            addTaskForm.addEventListener('submit', handleAddTask);
            resetFocusButton.addEventListener('click', handleResetFocus);
            exportButton.addEventListener('click', handleExport);
            importInput.addEventListener('change', handleImport);
            toggleFormButton.addEventListener('click', toggleAddTaskForm);

            // Listeners das Listas (delegação)
            focusList.addEventListener('click', handleListClick);
            backlogList.addEventListener('click', handleListClick);
            completedList.addEventListener('click', handleListClick);
            deletedList.addEventListener('click', handleDeletedListClick); // (NOVO)
            focusList.addEventListener('change', handleListChange);
            backlogList.addEventListener('change', handleListChange);
            completedList.addEventListener('change', handleListChange);

            // Listeners do Modal de Notas
            notesModalCloseBtn.addEventListener('click', closeNotesModal);
            notesModalBackdrop.addEventListener('click', closeNotesModal);
            notesModalForm.addEventListener('submit', handleSaveNotes);

            // (NOVO) Listeners do Modal de Confirmação
            confirmDeleteBtn.addEventListener('click', handleConfirmDelete);
            cancelDeleteBtn.addEventListener('click', closeDeleteConfirmModal);
            confirmDeleteBackdrop.addEventListener('click', closeDeleteConfirmModal);

            // Configuração Inicial
            initFormVisibility();
            loadTasks(); // Isso chama renderTasks()
            loadDeletedTasks(); // (NOVO) Isso chama renderDeletedTasks()
            checkRecurringTasks(); // (NOVO) Verifica recorrências
            initSortable();

            // (MODIFICADO) Renderiza todos os ícones estáticos (cabeçalho, etc) via JS
            renderStaticIcons();
        }

        // (MODIFICADO) Função para injetar SVGs estáticos
        function renderStaticIcons() {
            document.getElementById('logo-icon-placeholder').innerHTML = getIcon('logo');
            document.getElementById('import-icon-placeholder').innerHTML = getIcon('fileUp');
            document.getElementById('export-icon-placeholder').innerHTML = getIcon('fileDown');
            // O ícone 'toggle-form-button' é definido em initFormVisibility
            document.getElementById('focus-add-icon-placeholder').innerHTML = getIcon('moveToFocus');
            document.getElementById('backlog-add-icon-placeholder').innerHTML = getIcon('moveToBacklog');
            document.getElementById('focus-title-icon-placeholder').innerHTML = getIcon('titleSun');
            document.getElementById('backlog-title-icon-placeholder').innerHTML = getIcon('titleArchive');
            document.getElementById('completed-title-icon-placeholder').innerHTML = getIcon('titleCompleted');
            document.getElementById('completed-arrow-icon-placeholder').innerHTML = getIcon('chevronDown');
            document.getElementById('modal-close-icon-placeholder').innerHTML = getIcon('close');

            // (NOVO) Ícones da Lixeira e Modal de Confirmação
            document.getElementById('deleted-title-icon-placeholder').innerHTML = getIcon('titleDeleted');
            document.getElementById('deleted-arrow-icon-placeholder').innerHTML = getIcon('chevronDown');
            document.getElementById('confirm-delete-icon-placeholder').innerHTML = getIcon('alertTriangle');
        }


        // Inicia a aplicação
        document.addEventListener('DOMContentLoaded', initApp);
    </script>

</body>

</html>